<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>My Movie List</title>
    <style>
        /* ... ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼ ... */
        body { font-family: sans-serif; margin: 2em; }
        #search-container { margin-bottom: 2em; } /* ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        #movie-list { list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1em; }
        li { border: 1px solid #ccc; border-radius: 8px; padding: 1em; text-align: center; }
        img { max-width: 100%; height: auto; border-radius: 4px; }
        h3 { margin: 0.5em 0; }
    </style>
</head>
<body>

<div style="text-align: right;">
    <a href="/login.html">ë¡œê·¸ì¸</a>
</div>

<h1>ğŸ¬ ì˜í™” ëª©ë¡</h1>

<a href="/add-movie.html" style="margin-bottom: 1em; display: inline-block;">+ ìƒˆ ì˜í™” ì¶”ê°€í•˜ê¸°</a>

<div id="search-container">
    <input type="text" id="search-input" placeholder="ì˜í™” ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”...">
    <button id="search-button">ê²€ìƒ‰</button>
</div>

<ul id="movie-list"></ul>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const movieList = document.getElementById('movie-list');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');

        const token = localStorage.getItem('jwt'); // 1. localStorageì—ì„œ JWTë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login.html';
            return; // ì½”ë“œ ì‹¤í–‰ ì¤‘ë‹¨
        }

        const fetchOptions = {
            headers: {
                'Authorization': token // 2. Authorization í—¤ë”ì— í† í°ì„ ë‹´ìŠµë‹ˆë‹¤.
            }
        };

        // ===== 2. ì˜í™” ëª©ë¡ì„ í™”ë©´ì— ê·¸ë¦¬ëŠ” ë¶€ë¶„ì„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬ =====
        const displayMovies = (movies) => {
            movieList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ì„ ê¹¨ë—í•˜ê²Œ ë¹„ì›ë‹ˆë‹¤.

            movies.forEach(movie => {
                const listItem = document.createElement('li');
                const imageUrl = `https://image.tmdb.org/t/p/w200${movie.posterPath}`;

                // ===== ë³€ê²½ëœ ë¶€ë¶„ ì‹œì‘ =====
                // a íƒœê·¸ë¡œ ì „ì²´ ë‚´ìš©ì„ ê°ì‹¸ì„œ ë§í¬ë¥¼ ë§Œë“­ë‹ˆë‹¤.
                // href ì†ì„±ì— detail.html?id=ì˜í™”ID í˜•ì‹ìœ¼ë¡œ ì£¼ì†Œë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
                listItem.innerHTML = `
            <a href="detail.html?id=${movie.id}">
                <img src="${imageUrl}" alt="${movie.title} poster">
                <h3>${movie.title}</h3>
                <p>(${movie.releaseYear})</p>
            </a>
        `;
                // ===== ë³€ê²½ëœ ë¶€ë¶„ ë =====

                // a íƒœê·¸ì— ìŠ¤íƒ€ì¼ì„ ì¶”ê°€í•˜ì—¬ ë°‘ì¤„ì„ ì—†ì•±ë‹ˆë‹¤.
                listItem.querySelector('a').style.textDecoration = 'none';
                listItem.querySelector('a').style.color = 'inherit';

                movieList.appendChild(listItem);
            });
        };

        // ===== 3. ì´ˆê¸° í˜ì´ì§€ ë¡œë“œ ì‹œ ì „ì²´ ì˜í™” ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ =====
        const fetchAllMovies = () => {
            // 4. ì‹ ë¶„ì¦(fetchOptions)ê³¼ í•¨ê»˜ ì˜í™” ëª©ë¡ì„ ìš”ì²­í•©ë‹ˆë‹¤.
            fetch('/api/movies', fetchOptions)
                .then(response => {
                    if (response.status === 403) { // ì„œë²„ê°€ ì‹ ë¶„ì¦ì´ ìœ íš¨í•˜ì§€ ì•Šë‹¤ê³  ê±°ë¶€í•˜ë©´
                        alert('ì¸ì¦ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        localStorage.removeItem('jwt'); // ì˜ëª»ëœ ì‹ ë¶„ì¦ì€ ì§€ê°‘ì—ì„œ ì‚­ì œ
                        window.location.href = '/login.html';
                        return;
                    }
                    return response.json();
                })
                .then(movies => {
                    if(movies) displayMovies(movies);
                })
                .catch(error => console.error('ì˜í™” ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error));
        };

        // ===== 4. ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ =====
        searchButton.addEventListener('click', () => {
            // ê²€ìƒ‰ ì‹œì—ë„ ì‹ ë¶„ì¦(fetchOptions)ì„ í•¨ê»˜ ë³´ëƒ…ë‹ˆë‹¤.
            const searchTerm = searchInput.value;
            if (searchTerm) {
                fetch(`/api/movies/search?title=${searchTerm}`, fetchOptions)
                    .then(response => response.json())
                    .then(movies => displayMovies(movies))
                    .catch(error => console.error('ì˜í™” ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error));
            } else {
                fetchAllMovies();
            }
        });

        // í˜ì´ì§€ê°€ ì²˜ìŒ ì—´ë¦´ ë•Œ ì „ì²´ ì˜í™” ëª©ë¡ì„ í•œë²ˆ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
        fetchAllMovies();
    });
</script>

</body>
</html>