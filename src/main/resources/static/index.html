<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>My Movie List</title>
    <style>
        /* ... 스타일은 이전과 동일 ... */
        body { font-family: sans-serif; margin: 2em; }
        #search-container { margin-bottom: 2em; } /* 검색창 스타일 추가 */
        #movie-list { list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1em; }
        li { border: 1px solid #ccc; border-radius: 8px; padding: 1em; text-align: center; }
        img { max-width: 100%; height: auto; border-radius: 4px; }
        h3 { margin: 0.5em 0; }
    </style>
</head>
<body>

<div style="text-align: right;">
    <a href="/login.html">로그인</a>
</div>

<h1>🎬 영화 목록</h1>

<a href="/add-movie.html" style="margin-bottom: 1em; display: inline-block;">+ 새 영화 추가하기</a>

<div id="search-container">
    <input type="text" id="search-input" placeholder="영화 제목을 입력하세요...">
    <button id="search-button">검색</button>
</div>

<ul id="movie-list"></ul>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const movieList = document.getElementById('movie-list');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');

        const token = localStorage.getItem('jwt'); // 1. localStorage에서 JWT를 가져옵니다.

        if (!token) {
            alert('로그인이 필요합니다.');
            window.location.href = '/login.html';
            return; // 코드 실행 중단
        }

        const fetchOptions = {
            headers: {
                'Authorization': token // 2. Authorization 헤더에 토큰을 담습니다.
            }
        };

        // ===== 2. 영화 목록을 화면에 그리는 부분을 함수로 분리 =====
        const displayMovies = (movies) => {
            movieList.innerHTML = ''; // 기존 목록을 깨끗하게 비웁니다.

            movies.forEach(movie => {
                const listItem = document.createElement('li');
                const imageUrl = `https://image.tmdb.org/t/p/w200${movie.posterPath}`;

                // ===== 변경된 부분 시작 =====
                // a 태그로 전체 내용을 감싸서 링크를 만듭니다.
                // href 속성에 detail.html?id=영화ID 형식으로 주소를 지정합니다.
                listItem.innerHTML = `
            <a href="detail.html?id=${movie.id}">
                <img src="${imageUrl}" alt="${movie.title} poster">
                <h3>${movie.title}</h3>
                <p>(${movie.releaseYear})</p>
            </a>
        `;
                // ===== 변경된 부분 끝 =====

                // a 태그에 스타일을 추가하여 밑줄을 없앱니다.
                listItem.querySelector('a').style.textDecoration = 'none';
                listItem.querySelector('a').style.color = 'inherit';

                movieList.appendChild(listItem);
            });
        };

        // ===== 3. 초기 페이지 로드 시 전체 영화 목록을 가져오는 함수 =====
        const fetchAllMovies = () => {
            // 4. 신분증(fetchOptions)과 함께 영화 목록을 요청합니다.
            fetch('/api/movies', fetchOptions)
                .then(response => {
                    if (response.status === 403) { // 서버가 신분증이 유효하지 않다고 거부하면
                        alert('인증 정보가 유효하지 않습니다. 다시 로그인해주세요.');
                        localStorage.removeItem('jwt'); // 잘못된 신분증은 지갑에서 삭제
                        window.location.href = '/login.html';
                        return;
                    }
                    return response.json();
                })
                .then(movies => {
                    if(movies) displayMovies(movies);
                })
                .catch(error => console.error('영화 목록을 가져오는 중 오류 발생:', error));
        };

        // ===== 4. 검색 버튼 클릭 이벤트 처리 =====
        searchButton.addEventListener('click', () => {
            // 검색 시에도 신분증(fetchOptions)을 함께 보냅니다.
            const searchTerm = searchInput.value;
            if (searchTerm) {
                fetch(`/api/movies/search?title=${searchTerm}`, fetchOptions)
                    .then(response => response.json())
                    .then(movies => displayMovies(movies))
                    .catch(error => console.error('영화 검색 중 오류 발생:', error));
            } else {
                fetchAllMovies();
            }
        });

        // 페이지가 처음 열릴 때 전체 영화 목록을 한번 불러옵니다.
        fetchAllMovies();
    });
</script>

</body>
</html>