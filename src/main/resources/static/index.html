<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>My Movie List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-img-top { height: 300px; object-fit: cover; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">🎬 My Movie App</a>
        <div class="d-flex" id="auth-links">
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>영화 목록</h1>
        <a href="/add-movie.html" class="btn btn-primary">+ 새 영화 추가</a>
    </div>

    <div class="input-group mb-4">
        <input type="text" id="search-input" class="form-control" placeholder="영화 제목을 입력하세요...">
        <button id="search-button" class="btn btn-outline-secondary">검색</button>
    </div>

    <div id="movie-list" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const movieList = document.getElementById('movie-list');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const authLinks = document.getElementById('auth-links');

        const token = localStorage.getItem('jwt');

        if (!token) {
            authLinks.innerHTML = '<a href="/login.html" class="btn btn-success">로그인</a>';
            alert('로그인이 필요합니다.');
            window.location.href = '/login.html';
            return;
        } else {
            authLinks.innerHTML = '<button id="logout-button" class="btn btn-light">로그아웃</button>';
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.removeItem('jwt');
                alert('로그아웃 되었습니다.');
                window.location.href = '/login.html';
            });
        }

        const fetchOptions = { headers: { 'Authorization': token } };

        const displayMovies = (movies) => {
            movieList.innerHTML = '';
            movies.forEach(movie => {
                const imageUrl = movie.posterPath ? `https://image.tmdb.org/t/p/w500${movie.posterPath}` : 'https://via.placeholder.com/500x750.png?text=No+Image';
                const movieCard = `
                        <div class="col">
                            <div class="card h-100">
                                <a href="detail.html?id=${movie.id}">
                                    <img src="${imageUrl}" class="card-img-top" alt="${movie.title} poster">
                                </a>
                                <div class="card-body">
                                    <h5 class="card-title">${movie.title}</h5>
                                    <p class="card-text text-muted">(${movie.releaseYear})</p>
                                </div>
                            </div>
                        </div>
                    `;
                movieList.insertAdjacentHTML('beforeend', movieCard);
            });
        };

        const fetchAllMovies = () => {
            fetch('/api/movies', fetchOptions)
                .then(response => {
                    if (response.status === 403) {
                        localStorage.removeItem('jwt');
                        window.location.href = '/login.html';
                        return Promise.reject('Invalid token');
                    }
                    return response.json();
                })
                .then(movies => {
                    if(movies) displayMovies(movies);
                })
                .catch(error => console.error('Error fetching movies:', error));
        };

        searchButton.addEventListener('click', () => {
            const searchTerm = searchInput.value;
            if (searchTerm) {
                fetch(`/api/movies/search?title=${searchTerm}`, fetchOptions)
                    .then(response => response.json())
                    .then(movies => displayMovies(movies))
                    .catch(error => console.error('Error searching movies:', error));
            } else {
                fetchAllMovies();
            }
        });

        fetchAllMovies();
    });
</script>
</body>
</html>