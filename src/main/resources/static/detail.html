<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Movie Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">🎬 My Movie App</a>
        <div class="d-flex" id="auth-links"></div>
    </div>
</nav>

<div class="container mt-4">
    <p><a href="/">&laquo; 목록으로 돌아가기</a></p>
    <hr>
    <div id="movie-detail"></div>
    <hr>
    <div id="review-section" class="mt-4">
        <h2>리뷰</h2>
        <form id="review-form" class="mb-4">
            <div class="mb-3">
                <label for="review-content" class="form-label">리뷰 작성하기:</label>
                <textarea id="review-content" class="form-control" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">리뷰 제출</button>
        </form>
        <ul id="review-list" class="list-group"></ul>
    </div>
</div>

<script>
    // ... (JavaScript 로직은 이전과 동일) ...
    // 단, 로그아웃 버튼을 위한 코드가 추가됩니다.
    document.addEventListener('DOMContentLoaded', () => {
        const authLinks = document.getElementById('auth-links');
        const token = localStorage.getItem('jwt');
        if (!token) {
            authLinks.innerHTML = '<a href="/login.html" class="btn btn-success">로그인</a>';
            // 토큰 없으면 상세페이지 접근 불가
            alert('로그인이 필요합니다.');
            window.location.href = '/login.html';
            return;
        } else {
            authLinks.innerHTML = '<button id="logout-button" class="btn btn-light">로그아웃</button>';
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.removeItem('jwt');
                alert('로그아웃 되었습니다.');
                window.location.href = '/login.html';
            });
        }

        // ... (나머지 상세페이지 로직은 이전 답변과 거의 동일하며, Bootstrap 클래스에 맞게 일부 수정됨) ...
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('id');
        const movieDetail = document.getElementById('movie-detail');
        const reviewList = document.getElementById('review-list');
        const reviewForm = document.getElementById('review-form');

        const fetchOptions = { headers: { 'Authorization': token }};

        // 영화 상세 정보
        fetch(`/api/movies/${movieId}`, fetchOptions)
            .then(res => res.json())
            .then(movie => {
                const imageUrl = movie.posterPath ? `https://image.tmdb.org/t/p/w500${movie.posterPath}` : 'https://via.placeholder.com/500x750.png?text=No+Image';
                movieDetail.innerHTML = `
                        <div class="row">
                            <div class="col-md-4">
                                <img src="${imageUrl}" class="img-fluid rounded" alt="${movie.title} poster">
                            </div>
                            <div class="col-md-8">
                                <h1>${movie.title} <span class="text-muted">(${movie.releaseYear})</span></h1>
                                <p class="lead">${movie.overview}</p>
                                <a href="edit-movie.html?id=${movie.id}" class="btn btn-success">정보 수정</a>
                                <button id="delete-button" class="btn btn-danger">삭제</button>
                            </div>
                        </div>
                    `;
                document.getElementById('delete-button').addEventListener('click', () => {
                    if (confirm('정말로 이 영화를 삭제하시겠습니까?')) {
                        fetch(`/api/movies/${movieId}`, { method: 'DELETE', headers: { 'Authorization': token }})
                            .then(res => {
                                if(res.ok) {
                                    alert('삭제되었습니다.');
                                    window.location.href = '/';
                                } else {
                                    alert('삭제 실패');
                                }
                            });
                    }
                });
            });

        // 리뷰 목록
        fetch(`/api/movies/${movieId}/reviews`, fetchOptions)
            .then(res => res.json())
            .then(reviews => {
                reviewList.innerHTML = '';
                if (reviews.length > 0) {
                    reviews.forEach(review => {
                        reviewList.innerHTML += `
                                <li class="list-group-item">
                                    <strong>${review.username}</strong>
                                    <p class="mb-0">${review.content}</p>
                                </li>
                            `;
                    });
                } else {
                    reviewList.innerHTML = '<li class="list-group-item">작성된 리뷰가 없습니다.</li>';
                }
            });

        // 리뷰 작성
        reviewForm.addEventListener('submit', e => {
            e.preventDefault();
            const content = document.getElementById('review-content').value;
            fetch(`/api/movies/${movieId}/reviews`, {
                method: 'POST',
                headers: { 'Authorization': token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            })
                .then(res => res.json())
                .then(newReview => {
                    //... (이전과 동일한 로직)
                    window.location.reload(); // 간단하게 페이지 새로고침으로 처리
                });
        });
    });
</script>
</body>
</html>